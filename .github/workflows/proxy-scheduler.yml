name: ä»£ç†å®šæ™‚æŠ“å–èˆ‡é©—è­‰

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
  push:
    branches: [ main, master ]
    paths: 
      - 'proxy_management/**'
      - '.github/workflows/proxy-scheduler.yml'

env:
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.4.0'

jobs:
  proxy-scheduler:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£ uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: è¨­ç½®å¿«å–
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-
          
    - name: å‰µå»ºè™›æ“¬ç’°å¢ƒä¸¦å®‰è£ä¾è³´
      run: |
        uv venv
        uv pip install -e .
        
    - name: å‰µå»ºå¿…è¦çš„æ•¸æ“šç›®éŒ„
      run: |
        mkdir -p proxy_management/data/proxies
        mkdir -p proxy_management/data/archived
        mkdir -p proxy_management/exports/working-proxies
        mkdir -p proxy_management/logs/system
        mkdir -p proxy_management/logs/validation
        
    - name: é‹è¡Œä»£ç†èª¿åº¦å™¨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PROXY_SOURCES: ${{ secrets.PROXY_SOURCES }}
        MAX_PROXIES_TO_FETCH: ${{ secrets.MAX_PROXIES_TO_FETCH || '1000' }}
        VALIDATION_TIMEOUT: ${{ secrets.VALIDATION_TIMEOUT || '10' }}
        MAX_WORKERS: ${{ secrets.MAX_WORKERS || '50' }}
        RETRY_INVALID_PROXIES: ${{ secrets.RETRY_INVALID_PROXIES || 'true' }}
        CLEANUP_OLDER_THAN_DAYS: ${{ secrets.CLEANUP_OLDER_THAN_DAYS || '7' }}
      run: |
        source .venv/bin/activate
        python proxy_management/cloud_scheduler.py
        
    - name: æäº¤çµæžœåˆ°å€‰åº«
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰æ–°çš„ä»£ç†æ–‡ä»¶
        git add proxy_management/data/proxies/ || true
        git add proxy_management/data/archived/ || true
        git add proxy_management/exports/working-proxies/ || true
        git add proxy_management/logs/ || true
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "æ²’æœ‰æ–°çš„ä»£ç†æ•¸æ“šéœ€è¦æäº¤"
        else
          git commit -m "ðŸ¤– è‡ªå‹•æ›´æ–°ä»£ç†æ•¸æ“š - $(date '+%Y-%m-%d %H:%M:%S')"
          git push || echo "æŽ¨é€å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œ"
        fi
        
    - name: ä¸Šå‚³åŸ·è¡Œæ—¥èªŒ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: proxy-scheduler-logs-${{ github.run_number }}
        path: |
          proxy_management/logs/
          !proxy_management/logs/**/*.log
        retention-days: 30
        
    - name: ç”ŸæˆåŸ·è¡Œå ±å‘Š
      if: always()
      run: |
        echo "## ðŸ“Š ä»£ç†æŠ“å–åŸ·è¡Œå ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "**åŸ·è¡Œæ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**å·¥ä½œæµé‹è¡Œç·¨è™Ÿ**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "proxy_management/logs/system/scheduler_report.json" ]; then
          echo "### ðŸ“ˆ çµ±è¨ˆæ•¸æ“š" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat proxy_management/logs/system/scheduler_report.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "proxy_management/exports/working-proxies/working_proxies.csv" ]; then
          WORKING_COUNT=$(wc -l < proxy_management/exports/working-proxies/working_proxies.csv)
          echo "### âœ… æœ‰æ•ˆä»£ç†æ•¸é‡: $((WORKING_COUNT - 1))" >> $GITHUB_STEP_SUMMARY
        fi